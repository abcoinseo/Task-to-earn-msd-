<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TaskToEarn — Admin Panel</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    :root{--bg:#f4f6f8;--card:#fff;--accent:#007bff;--muted:#6c757d}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,Arial;background:var(--bg);color:#222}
    header{background:var(--accent);color:#fff;padding:14px 20px;display:flex;align-items:center;gap:12px}
    header h1{font-size:18px;margin:0}
    .wrap{max-width:1100px;margin:18px auto;padding:16px}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:16px}
    .card{background:var(--card);border-radius:10px;padding:14px;box-shadow:0 6px 18px rgba(20,20,30,0.06)}
    .section-title{margin:0 0 8px;font-weight:600}
    .row{display:flex;gap:8px;align-items:center}
    input,select,textarea,button{padding:8px;border-radius:6px;border:1px solid #e0e0e0}
    button{cursor:pointer;background:var(--accent);color:#fff;border:none}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;text-align:left;border-bottom:1px solid #eef2f6;font-size:13px}
    th{background:#fafbfd}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    .actions button{margin-right:6px}
    .stack{display:flex;flex-direction:column;gap:8px}
    .inline{display:flex;gap:8px}
    .danger{background:#e55353}
    .success{background:#28a745}
    pre{white-space:pre-wrap;word-break:break-word;background:#0b1220;color:#d1ffd6;padding:10px;border-radius:6px;overflow:auto}
    footer{font-size:12px;color:var(--muted);text-align:center;margin-top:12px}
    @media (max-width:880px){.grid{grid-template-columns:1fr;}.wrap{padding:8px}}
  </style>
</head>
<body>
  <header>
    <i class="material-icons">admin_panel_settings</i>
    <h1>TaskToEarn — Admin Panel</h1>
  </header>
  <div class="wrap">
    <div class="grid">
      <div>
        <div class="card">
          <h2 class="section-title">Firebase & Bot Settings</h2>
          <div class="stack">
            <label class="small muted">Firebase Database URL</label>
            <input id="firebaseUrl" placeholder="https://your-project.firebaseio.com" />

            <label class="small muted">Bot Token (kept here for demo — recommend server)</label>
            <input id="botToken" placeholder="Bot token" />

            <div class="inline">
              <button id="saveSettingsBtn">Save Settings</button>
              <button id="testBotBtn">Test Send Message</button>
            </div>
            <div id="settingsMsg" class="small muted"></div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h2 class="section-title">Manage Tasks</h2>
          <div class="stack">
            <input id="taskTitle" placeholder="Title" />
            <input id="taskReward" placeholder="Reward (points)" type="number" />
            <input id="taskUrl" placeholder="Task URL (must start with http)" />
            <input id="taskEmoji" placeholder="Emoji/icon (optional)" />
            <div class="inline">
              <button id="addTaskBtn">Add Task</button>
              <button id="refreshTasksBtn" style="background:#6c757d">Refresh</button>
            </div>
            <div id="tasksContainer"></div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h2 class="section-title">Withdrawal Requests</h2>
          <div class="stack">
            <div id="withdrawalsContainer">Loading...</div>
            <div class="small muted">Actions will optionally send Telegram messages to users.</div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h2 class="section-title">Users</h2>
          <div class="stack">
            <input id="searchUserInput" placeholder="Search by telegram id or username" />
            <div id="usersContainer">Loading users...</div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h2 class="section-title">Message Campaign</h2>
          <div class="stack">
            <input id="campName" placeholder="Campaign name (internal)" />
            <input id="campText" placeholder="Message text (use {{first_name}} {{username}} {{id}})" />
            <input id="campImage" placeholder="Image URL (optional)" />
            <textarea id="inlineButtons" placeholder='Inline buttons JSON (e.g. [{"text":"Open","url":"https://t.me/yourbot"}])' rows="3"></textarea>
            <div class="inline">
              <button id="previewCampaignBtn">Preview</button>
              <button id="sendCampaignBtn">Send to All Users</button>
            </div>
            <div id="campaignLog" class="small muted"></div>
          </div>
        </div>
      </div>

      <aside>
        <div class="card">
          <h3 class="section-title">Quick Tools</h3>
          <div class="stack">
            <button id="exportUsersBtn">Export Users JSON</button>
            <button id="deleteAllTasksBtn" class="danger">Delete All Tasks</button>
            <button id="clearTestDataBtn" style="background:#ff9f1c">Clear Test Withdrawals</button>
            <div id="quickMsg" class="small muted"></div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3 class="section-title">Logs & CORS Help</h3>
          <div class="small muted">
            <p>Note: Sending requests to <code>api.telegram.org</code> from a browser may hit CORS restrictions. If "send" fails with a network/CORS error, use the generated cURL command shown below on a server or use a simple serverless function (recommended).</p>
            <pre id="curlBox">No curl yet</pre>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3 class="section-title">Debug</h3>
          <div id="debugBox" class="small muted">Ready</div>
        </div>
      </aside>
    </div>

    <footer>
      Built for TaskToEarn — admin.html (demo). For production, move Telegram bot operations to a secure server or Cloud Function to keep your bot token secret and avoid CORS issues.
    </footer>
  </div>

  <!-- Firebase SDK (client) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
    // ---------- DEFAULT CONFIG: replace with your project's values if different ----------
    const defaultFirebaseConfig = {
      apiKey: "AIzaSyCCe90-ebayqVHnNBIdJVb5NujfgG0ZpPo",
      authDomain: "msdbot-279c5.firebaseapp.com",
      databaseURL: "https://msdbot-279c5-default-rtdb.firebaseio.com",
      projectId: "msdbot-279c5",
      storageBucket: "msdbot-279c5.firebasestorage.app",
      messagingSenderId: "615801744801",
      appId: "1:615801744801:web:1fb3d1dedc8d61ae686fe0"
    };

    // ---------- Helper state ----------
    let firebaseInitialized = false;
    let db = null;

    // ---------- DOM ----------
    const firebaseUrlInput = document.getElementById('firebaseUrl');
    const botTokenInput = document.getElementById('botToken');
    const saveSettingsBtn = document.getElementById('saveSettingsBtn');
    const testBotBtn = document.getElementById('testBotBtn');
    const settingsMsg = document.getElementById('settingsMsg');
    const tasksContainer = document.getElementById('tasksContainer');
    const addTaskBtn = document.getElementById('addTaskBtn');
    const refreshTasksBtn = document.getElementById('refreshTasksBtn');
    const withdrawalsContainer = document.getElementById('withdrawalsContainer');
    const usersContainer = document.getElementById('usersContainer');
    const searchUserInput = document.getElementById('searchUserInput');
    const curlBox = document.getElementById('curlBox');
    const debugBox = document.getElementById('debugBox');

    // Campaign
    const previewCampaignBtn = document.getElementById('previewCampaignBtn');
    const sendCampaignBtn = document.getElementById('sendCampaignBtn');
    const campText = document.getElementById('campText');
    const campImage = document.getElementById('campImage');
    const inlineButtons = document.getElementById('inlineButtons');
    const campName = document.getElementById('campName');
    const campaignLog = document.getElementById('campaignLog');

    // Quick tools
    const exportUsersBtn = document.getElementById('exportUsersBtn');
    const deleteAllTasksBtn = document.getElementById('deleteAllTasksBtn');
    const clearTestDataBtn = document.getElementById('clearTestDataBtn');

    // Task inputs
    const taskTitle = document.getElementById('taskTitle');
    const taskReward = document.getElementById('taskReward');
    const taskUrl = document.getElementById('taskUrl');
    const taskEmoji = document.getElementById('taskEmoji');

    // ---------- Init values (optional) ----------
    firebaseUrlInput.value = defaultFirebaseConfig.databaseURL;
    // If you provided a token earlier in your app, prefill here. Replace with your token or leave blank.
    botTokenInput.value = '8439186964:AAHsE3bcXR-zOgbYwGRi1OZdp9ue13OTI24';

    // ---------- Initialize Firebase (client) ----------
    function initFirebase(config = defaultFirebaseConfig) {
      try {
        if (!firebaseInitialized) {
          firebase.initializeApp(config);
          db = firebase.database();
          firebaseInitialized = true;
          settingsMsg.textContent = 'Firebase initialized.';
          listenForData();
        }
      } catch (e) {
        settingsMsg.textContent = 'Error initializing firebase: ' + e.message;
        console.error(e);
      }
    }

    // ---------- Listeners ----------
    function listenForData() {
      if (!db) return;
      // Tasks
      db.ref('tasks').on('value', snapshot => {
        const tasks = snapshot.val() || {};
        renderTasks(tasks);
      });

      // Withdrawals
      db.ref('withdrawalRequests').on('value', snapshot => {
        const reqs = snapshot.val() || {};
        renderWithdrawals(reqs);
      });

      // Users
      db.ref('users').on('value', snapshot => {
        const users = snapshot.val() || {};
        renderUsers(users);
      });
    }

    // ---------- Tasks ----------
    function renderTasks(tasks) {
      tasksContainer.innerHTML = '';
      const ids = Object.keys(tasks);
      if (!ids.length) { tasksContainer.innerHTML = '<div class="small muted">No tasks</div>'; return; }
      const table = document.createElement('table');
      table.innerHTML = '<tr><th>Title</th><th>Reward</th><th>Url</th><th>Actions</th></tr>';
      ids.forEach(id => {
        const t = tasks[id];
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${t.title || ''}</td><td>${t.reward||0}</td><td class="small muted">${t.taskUrl||''}</td><td class="actions"></td>`;
        const actionsTd = tr.querySelector('.actions');
        const delBtn = document.createElement('button'); delBtn.textContent='Delete'; delBtn.className='danger';
        delBtn.addEventListener('click', () => deleteTask(id));
        const toggleBtn = document.createElement('button'); toggleBtn.textContent = t.active ? 'Deactivate' : 'Activate'; toggleBtn.style.background='#6c757d';
        toggleBtn.addEventListener('click', () => toggleTaskActive(id, !t.active));
        actionsTd.appendChild(toggleBtn); actionsTd.appendChild(delBtn);
        table.appendChild(tr);
      });
      tasksContainer.appendChild(table);
    }

    async function addTask() {
      if (!db) { alert('Init firebase first'); return; }
      const title = taskTitle.value.trim();
      const reward = parseInt(taskReward.value) || 0;
      const url = taskUrl.value.trim();
      const emoji = taskEmoji.value.trim() || '⭐';
      if (!title || !url) { alert('Title and URL required'); return; }
      const newKey = db.ref('tasks').push().key;
      const payload = { title, reward, taskUrl: url, iconEmoji: emoji, active: true };
      await db.ref('tasks/' + newKey).set(payload);
      taskTitle.value=''; taskReward.value=''; taskUrl.value=''; taskEmoji.value='';
      settingsMsg.textContent = 'Task added.';
    }

    async function deleteTask(id) {
      if (!confirm('Delete this task?')) return;
      await db.ref('tasks/' + id).remove();
      settingsMsg.textContent = 'Task deleted.';
    }

    async function toggleTaskActive(id, val) {
      await db.ref('tasks/' + id + '/active').set(!!val);
      settingsMsg.textContent = 'Task updated.';
    }

    // ---------- Withdrawals ----------
    function renderWithdrawals(reqs) {
      withdrawalsContainer.innerHTML = '';
      const ids = Object.keys(reqs).sort((a,b)=> (reqs[b].timestamp||0)-(reqs[a].timestamp||0));
      if (!ids.length) { withdrawalsContainer.innerHTML = '<div class="small muted">No withdrawal requests.</div>'; return; }
      const frag = document.createDocumentFragment();
      ids.forEach(id => {
        const r = reqs[id];
        const div = document.createElement('div'); div.className='card'; div.style.marginBottom='8px';
        div.innerHTML = `<div><strong>${r.username||r.userId}</strong> — <span class="small muted">${r.amountPoints} pts</span></div>
          <div class="small muted">${r.tonAddress || ''}</div>
          <div class="inline" style="margin-top:8px"></div>`;
        const actions = div.querySelector('.inline');
        const approve = document.createElement('button'); approve.textContent='Approve'; approve.className='success';
        const reject = document.createElement('button'); reject.textContent='Reject'; reject.className='danger';
        const noteBtn = document.createElement('button'); noteBtn.textContent='Message User'; noteBtn.style.background='#6c757d';
        approve.addEventListener('click', ()=> handleWithdrawalAction(id, 'approved', r));
        reject.addEventListener('click', ()=> handleWithdrawalAction(id, 'rejected', r));
        noteBtn.addEventListener('click', ()=> openMessagePrompt(r.userId, r.username));
        actions.appendChild(approve); actions.appendChild(reject); actions.appendChild(noteBtn);
        frag.appendChild(div);
      });
      withdrawalsContainer.appendChild(frag);
    }

    async function handleWithdrawalAction(id, status, req) {
      if (!db) return;
      if (!confirm(`Mark withdrawal ${id} as ${status}?`)) return;
      // Update request status
      await db.ref('withdrawalRequests/' + id + '/status').set(status);
      // Update user's withdrawalHistory if present
      if (req.userId) {
        await db.ref('users/' + req.userId + '/withdrawalHistory/' + id + '/status').set(status);
      }
      settingsMsg.textContent = 'Withdrawal updated to ' + status;
      // Send Telegram message to user (try client-side; may fail due to CORS)
      const botToken = botTokenInput.value.trim();
      if (botToken) {
        const text = `Your withdrawal request (${req.amountPoints} pts) has been ${status.toUpperCase()}.`;
        const sendResult = await sendTelegramMessage(req.userId, text);
        console.log('sendResult', sendResult);
      }
    }

    // ---------- Users ----------
    function renderUsers(users) {
      usersContainer.innerHTML = '';
      const ids = Object.keys(users).sort((a,b)=> (users[b].points||0)-(users[a].points||0));
      if (!ids.length) { usersContainer.innerHTML = '<div class="small muted">No users</div>'; return; }
      const table = document.createElement('table');
      table.innerHTML = '<tr><th>ID</th><th>User</th><th>Points</th><th>Actions</th></tr>';
      ids.forEach(id => {
        const u = users[id];
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${id}</td><td>${u.username||u.firstName||''}</td><td>${u.points||0}</td><td class="actions"></td>`;
        const actionsTd = tr.querySelector('.actions');
        const addPoints = document.createElement('button'); addPoints.textContent='+100'; addPoints.style.background='#28a745';
        addPoints.addEventListener('click', ()=> adjustUserPoints(id, 100));
        const subPoints = document.createElement('button'); subPoints.textContent='-100'; subPoints.style.background='#e55353';
        subPoints.addEventListener('click', ()=> adjustUserPoints(id, -100));
        const msgBtn = document.createElement('button'); msgBtn.textContent='Message'; msgBtn.style.background='#6c757d';
        msgBtn.addEventListener('click', ()=> openMessagePrompt(id, u.username));
        actionsTd.appendChild(addPoints); actionsTd.appendChild(subPoints); actionsTd.appendChild(msgBtn);
        table.appendChild(tr);
      });
      usersContainer.appendChild(table);
    }

    async function adjustUserPoints(userId, delta) {
      if (!db) return;
      await db.ref('users/' + userId + '/points').set(firebase.database.ServerValue.increment(delta));
      settingsMsg.textContent = `Adjusted ${userId} by ${delta}`;
    }

    // ---------- Messaging ----------
    function openMessagePrompt(userId, username) {
      const text = prompt('Message text to send to user ' + (username||userId), '');
      if (!text) return;
      sendTelegramMessage(userId, text).then(r=> console.log(r));
    }

    async function sendTelegramMessage(chatId, text, opts = {}) {
      const token = botTokenInput.value.trim();
      if (!token) { alert('Set bot token'); return; }

      // Build request body for sendMessage or sendPhoto
      try {
        if (opts.photo || campImage.value.trim()) {
          // prefer sendPhoto when image present
          const form = new FormData();
          form.append('chat_id', chatId);
          form.append('caption', text);
          form.append('photo', opts.photo || campImage.value.trim());
          // sendPhoto requires file upload; we pass URL — Telegram supports photo by URL
          const url = `https://api.telegram.org/bot${token}/sendPhoto`;
          const res = await fetch(url, { method: 'POST', body: form });
          const data = await res.json();
          if (!res.ok) throw new Error(JSON.stringify(data));
          return data;
        } else {
          const payload = { chat_id: chatId, text: text, parse_mode: 'HTML' };
          if (opts.reply_markup) payload.reply_markup = JSON.stringify(opts.reply_markup);
          const url = `https://api.telegram.org/bot${token}/sendMessage`;
          const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
          const data = await res.json();
          if (!res.ok) throw new Error(JSON.stringify(data));
          return data;
        }
      } catch (err) {
        console.error('Telegram send failed (likely CORS when called from browser):', err);
        // Show curl fallback
        const curl = buildCurlCommand(chatId, text, token, opts.reply_markup, opts.photo || campImage.value.trim());
        curlBox.textContent = curl;
        debugBox.textContent = 'Telegram send failed from browser. Use the cURL command in "Logs & CORS Help" or run a small server-side function.';
        return { ok: false, error: err.message };
      }
    }

    function buildCurlCommand(chatId, text, token, reply_markup, photo) {
      const tokenSafe = token || '{{BOT_TOKEN}}';
      if (photo) {
        // sendPhoto with URL
        return `curl -s -X POST https://api.telegram.org/bot${tokenSafe}/sendPhoto -F chat_id=${chatId} -F photo='${photo}' -F caption='${text.replace(/'/g, "'\\''")}'`;
      }
      let body = { chat_id: chatId, text: text, parse_mode: 'HTML' };
      if (reply_markup) body.reply_markup = reply_markup;
      return `curl -s -X POST https://api.telegram.org/bot${tokenSafe}/sendMessage -H 'Content-Type: application/json' -d '${JSON.stringify(body).replace(/'/g, "'\\''")}'`;
    }

    // ---------- Campaign ----------
    previewCampaignBtn.addEventListener('click', ()=> {
      const sample = { id: '12345', first_name: 'Test', username: 'tester' };
      const text = applyTemplate(campText.value || 'Hello {{first_name}}', sample);
      campaignLog.textContent = text;
    });

    sendCampaignBtn.addEventListener('click', async ()=> {
      if (!confirm('Send campaign to ALL users? This will attempt to message each user (may fail due to CORS).')) return;
      campaignLog.textContent = 'Sending...';
      const usersSnap = await db.ref('users').once('value');
      const users = usersSnap.val() || {};
      const ids = Object.keys(users);
      let parsedButtons = null;
      try { parsedButtons = JSON.parse(inlineButtons.value || '[]'); } catch(e){ parsedButtons = null; }

      for (const id of ids) {
        const u = users[id];
        const text = applyTemplate(campText.value || '', { id, first_name: u.firstName||u.first_name||'', username: u.username||'' });
        const rm = parsedButtons && parsedButtons.length ? { inline_keyboard: [parsedButtons] } : undefined;
        try {
          await sendTelegramMessage(id, text, { reply_markup: rm });
          campaignLog.textContent = `Sent to ${id}`;
        } catch(e) {
          campaignLog.textContent = `Failed to ${id}`;
        }
        // NOTE: No rate-limiting implemented here — for real campaigns add batching/delays
      }
      campaignLog.textContent = 'Done';
    });

    function applyTemplate(template, vars) {
      return template.replace(/{{\s*(\w+)\s*}}/g, (_, key)=> vars[key] || '');
    }

    // ---------- Quick Tools ----------
    exportUsersBtn.addEventListener('click', async ()=>{
      const snap = await db.ref('users').once('value');
      const data = snap.val() || {};
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download='users.json'; a.click();
      URL.revokeObjectURL(url);
    });

    deleteAllTasksBtn.addEventListener('click', async ()=>{
      if (!confirm('Delete ALL tasks?')) return;
      await db.ref('tasks').remove();
      settingsMsg.textContent = 'All tasks removed.';
    });

    clearTestDataBtn.addEventListener('click', async ()=>{
      if (!confirm('Clear withdrawalRequests node?')) return;
      await db.ref('withdrawalRequests').remove();
      settingsMsg.textContent = 'Withdrawals cleared.';
    });

    // ---------- Small helpers ----------
    saveSettingsBtn.addEventListener('click', ()=>{
      const url = firebaseUrlInput.value.trim();
      try {
        // For the client SDK we only need to initialize with project config; but user provided DB url is used to suggest config
        initFirebase(defaultFirebaseConfig);
        settingsMsg.textContent = 'Settings saved. Listening to Firebase.';
      } catch(e){ settingsMsg.textContent = 'Error: '+e.message; }
    });

    testBotBtn.addEventListener('click', async ()=>{
      const token = botTokenInput.value.trim();
      if (!token) { alert('Set bot token'); return; }
      const chat = prompt('Enter a chat id to test (your Telegram id)');
      if (!chat) return;
      const result = await sendTelegramMessage(chat, 'Test message from admin panel');
      alert('Result logged to console. If it failed, check CORS/fallback cURL in the Logs panel.');
      console.log(result);
    });

    addTaskBtn.addEventListener('click', addTask);
    refreshTasksBtn.addEventListener('click', ()=> { if (db) db.ref('tasks').once('value').then(s=>renderTasks(s.val()||{})); });

    searchUserInput.addEventListener('input', ()=>{
      const q = searchUserInput.value.trim().toLowerCase();
      // simple client-side filter (users cached by renderUsers)
      if (!q) { if (db) db.ref('users').once('value').then(s=>renderUsers(s.val()||{})); return; }
      db.ref('users').once('value').then(s=>{
        const all = s.val()||{}; const filtered = {};
        Object.keys(all).forEach(k=>{ const u = all[k]; if (k.includes(q) || (u.username||'').toLowerCase().includes(q)) filtered[k]=u; });
        renderUsers(filtered);
      });
    });

    // Auto-init firebase for convenience
    initFirebase(defaultFirebaseConfig);
  </script>
</body>
    </html>
